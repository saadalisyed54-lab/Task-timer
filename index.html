<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Task Timer</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --panel-bg: #f4f4f4;
            --accent-color: #4CAF50;
            --danger-color: #ff4444;
            --button-text: #ffffff;
            --border-radius: 8px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* THEMES */
        body.theme-1 { --bg-color: #ffffff; --text-color: #222; --panel-bg: #f0f0f0; --accent-color: #2196F3; } /* Default Light */
        body.theme-2 { --bg-color: #121212; --text-color: #eee; --panel-bg: #1e1e1e; --accent-color: #BB86FC; } /* Dark Mode */
        body.theme-3 { --bg-color: #ffffec; --text-color: #3e2723; --panel-bg: #fff8e1; --accent-color: #ffab00; } /* Cream */
        body.theme-4 { --bg-color: #e0f7fa; --text-color: #006064; --panel-bg: #b2ebf2; --accent-color: #00bcd4; } /* Cyan Light */
        body.theme-5 { --bg-color: #002b36; --text-color: #839496; --panel-bg: #073642; --accent-color: #2aa198; } /* Solarized Dark */
        body.theme-6 { --bg-color: #fdf6e3; --text-color: #657b83; --panel-bg: #eee8d5; --accent-color: #859900; } /* Solarized Light */
        body.theme-7 { --bg-color: #282c34; --text-color: #abb2bf; --panel-bg: #353a45; --accent-color: #61afef; } /* Atom */
        body.theme-8 { --bg-color: #2e3440; --text-color: #d8dee9; --panel-bg: #3b4252; --accent-color: #88c0d0; } /* Nordic */
        body.theme-9 { --bg-color: #fff0f5; --text-color: #880e4f; --panel-bg: #fce4ec; --accent-color: #e91e63; } /* Pink */
        body.theme-10 { --bg-color: #e8f5e9; --text-color: #1b5e20; --panel-bg: #c8e6c9; --accent-color: #43a047; } /* Mint */
        body.theme-11 { --bg-color: #000000; --text-color: #ffffff; --panel-bg: #333333; --accent-color: #ffffff; } /* High Contrast */
        body.theme-12 { --bg-color: #1a1a2e; --text-color: #e94560; --panel-bg: #16213e; --accent-color: #0f3460; } /* Cyber */
        body.theme-13 { --bg-color: #3e2723; --text-color: #efebe9; --panel-bg: #4e342e; --accent-color: #d7ccc8; } /* Coffee */
        body.theme-14 { --bg-color: #311b92; --text-color: #ede7f6; --panel-bg: #4527a0; --accent-color: #7c4dff; } /* Deep Purple */
        body.theme-15 { --bg-color: #f3e5f5; --text-color: #4a148c; --panel-bg: #e1bee7; --accent-color: #8e24aa; } /* Lavender */
        body.theme-16 { --bg-color: #827717; --text-color: #f9fbe7; --panel-bg: #9e9d24; --accent-color: #cddc39; } /* Olive */
        body.theme-17 { --bg-color: #263238; --text-color: #eceff1; --panel-bg: #37474f; --accent-color: #ff5722; } /* Slate */
        body.theme-18 { --bg-color: #bf360c; --text-color: #fff3e0; --panel-bg: #d84315; --accent-color: #ffab91; } /* Burnt Orange */
        body.theme-19 { --bg-color: #0d47a1; --text-color: #e3f2fd; --panel-bg: #1565c0; --accent-color: #64b5f6; } /* Ocean */
        body.theme-20 { --bg-color: #424242; --text-color: #bdbdbd; --panel-bg: #616161; --accent-color: #ffca28; } /* Gray & Gold */

        * { box-sizing: border-box; }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            padding: 15px;
            background: var(--panel-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent-color);
        }
        .token-display { font-weight: bold; font-size: 1.2rem; }
        .controls { display: flex; gap: 10px; }
        
        /* NAVIGATION */
        nav {
            display: flex;
            overflow-x: auto;
            background: var(--panel-bg);
            padding: 5px;
            gap: 5px;
        }
        nav button {
            flex: 1;
            white-space: nowrap;
            padding: 10px;
            background: transparent;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        nav button.active { border-bottom-color: var(--accent-color); font-weight: bold; }

        /* CONTENT */
        main { flex: 1; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; }
        .page { display: none; }
        .page.active { display: block; }
        
        /* CARDS & FORMS */
        .card {
            background: var(--panel-bg);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        input, select {
            padding: 10px;
            border: 1px solid var(--text-color);
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 4px;
            flex: 1;
        }

        button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            background: var(--accent-color);
            color: var(--button-text);
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button.danger { background: var(--danger-color); }
        button.secondary { background: #777; }

        /* TIMER VISUALS */
        .timer-display { font-size: 2rem; font-family: monospace; text-align: center; margin: 10px 0; }
        .progress-bar {
            height: 10px;
            background: #ccc;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            width: 100%;
            transition: width 0.1s linear;
        }

        /* MODAL */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--panel-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            max-width: 90%;
        }
        .modal-actions { display: flex; gap: 20px; margin-top: 20px; justify-content: center; }

        /* LOG */
        .log-panel {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid var(--text-color);
        }

        /* RESPONSIVE */
        @media (max-width: 600px) {
            .input-group { flex-direction: column; }
            nav button { font-size: 0.9rem; padding: 8px; }
        }
    </style>
</head>
<body class="theme-1">

<header>
    <div class="token-display">Tokens: <span id="token-count">0</span></div>
    <div class="controls">
        <select id="theme-selector" onchange="changeTheme()"></select>
        <button onclick="resetTokens()" class="secondary">Reset Tokens</button>
    </div>
</header>

<nav>
    <button onclick="showPage('running')" id="nav-running" class="active">Running</button>
    <button onclick="showPage('paused')" id="nav-paused">Paused</button>
    <button onclick="showPage('completed')" id="nav-completed">Completed</button>
    <button onclick="showPage('failed')" id="nav-failed">Not Completed</button>
    <button onclick="showPage('library')" id="nav-library">Library</button>
</nav>

<main>
    <!-- RUNNING TASKS -->
    <div id="running" class="page active">
        <div class="card">
            <h3>Quick Start Task</h3>
            <div class="input-group">
                <input type="text" id="new-task-name" placeholder="Task Name">
                <input type="number" id="new-task-time" placeholder="Mins">
                <input type="number" id="new-task-reward" placeholder="Reward">
                <input type="number" id="new-task-penalty" placeholder="Penalty">
            </div>
            <button onclick="startNewTask()">Start Task</button>
        </div>
        <div id="running-list"></div>
        <button onclick="resetPage('running')" class="danger" style="margin-top:20px">Reset Running</button>
    </div>

    <!-- PAUSED TASKS -->
    <div id="paused" class="page">
        <h2>Paused Tasks</h2>
        <div id="paused-list"></div>
        <button onclick="resetPage('paused')" class="danger" style="margin-top:20px">Reset Paused</button>
    </div>

    <!-- COMPLETED TASKS -->
    <div id="completed" class="page">
        <h2>Completed History</h2>
        <div id="completed-list"></div>
        <button onclick="resetPage('completed')" class="danger" style="margin-top:20px">Reset Completed</button>
    </div>

    <!-- NOT COMPLETED TASKS -->
    <div id="failed" class="page">
        <h2>Failed History</h2>
        <div id="failed-list"></div>
        <button onclick="resetPage('failed')" class="danger" style="margin-top:20px">Reset Failed</button>
    </div>

    <!-- LIBRARY -->
    <div id="library" class="page">
        <div class="card">
            <h3>Create Permanent Task</h3>
            <div class="input-group">
                <input type="text" id="lib-name" placeholder="Task Name">
                <input type="number" id="lib-time" placeholder="Mins">
                <input type="number" id="lib-reward" placeholder="Reward">
                <input type="number" id="lib-penalty" placeholder="Penalty">
            </div>
            <button onclick="addToLibrary()">Save to Library</button>
        </div>
        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <label class="switch">
                <input type="checkbox" id="control-toggle" onchange="toggleControls()">
                Show All Task Controls
            </label>
        </div>
        <div id="library-list"></div>
        <button onclick="resetAllTasks()" class="danger" style="margin-top:20px">Reset All Progress (Keep Library)</button>
        <br><br>
        <button onclick="masterReset()" class="danger">MASTER RESET (Clear Everything)</button>
    </div>

    <!-- LOG -->
    <div class="log-panel">
        <strong>Activity Log:</strong>
        <div id="activity-log"></div>
    </div>
</main>

<!-- FULL SCREEN MODAL -->
<div id="modal-overlay">
    <div class="modal-content">
        <h1 id="modal-task-name">Task Name</h1>
        <h2>Time is up!</h2>
        <div class="modal-actions">
            <button onclick="resolveTask(true)" class="accent">✅ Completed</button>
            <button onclick="resolveTask(false)" class="danger">❌ Not Completed</button>
        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let state = {
        tasks: [],
        library: [],
        tokens: 0,
        themeIndex: 0,
        logs: [],
        showControls: false
    };

    // Load from LocalStorage
    function loadData() {
        const saved = localStorage.getItem('offlineTimerState');
        if (saved) {
            state = JSON.parse(saved);
        }
        applyTheme();
        renderAll();
        // Resume timer loop
        requestAnimationFrame(tick);
    }

    function saveData() {
        localStorage.setItem('offlineTimerState', JSON.stringify(state));
        renderAll(); // Re-render to show updates
    }

    function logAction(action) {
        state.logs.unshift(action);
        if (state.logs.length > 3) state.logs.pop();
        saveData();
    }

    // --- TASK LOGIC ---

    function createId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

    function startNewTask() {
        const name = document.getElementById('new-task-name').value;
        const mins = parseFloat(document.getElementById('new-task-time').value);
        const reward = parseFloat(document.getElementById('new-task-reward').value);
        const penalty = parseFloat(document.getElementById('new-task-penalty').value);

        if (!name || isNaN(mins) || isNaN(reward) || isNaN(penalty)) return;

        addTaskToState(name, mins, reward, penalty);
        
        // Clear inputs
        document.getElementById('new-task-name').value = '';
        document.getElementById('new-task-time').value = '';
        document.getElementById('new-task-reward').value = '';
        document.getElementById('new-task-penalty').value = '';
    }

    function addTaskToState(name, mins, reward, penalty) {
        const totalMs = mins * 60 * 1000;
        const newTask = {
            id: createId(),
            name,
            totalTime: totalMs,
            remaining: totalMs,
            endTime: Date.now() + totalMs,
            status: 'running',
            reward,
            penalty
        };
        state.tasks.push(newTask);
        logAction(`Task started: ${name}`);
        saveData();
    }

    function pauseTask(id) {
        const task = state.tasks.find(t => t.id === id);
        if (task && task.status === 'running') {
            // Calculate actual remaining based on current time
            task.remaining = task.endTime - Date.now();
            task.endTime = null; // Clear end time
            task.status = 'paused';
            logAction(`Task paused: ${task.name}`);
            saveData();
        }
    }

    function resumeTask(id) {
        const task = state.tasks.find(t => t.id === id);
        if (task && task.status === 'paused') {
            task.endTime = Date.now() + task.remaining;
            task.status = 'running';
            logAction(`Task resumed: ${task.name}`);
            saveData();
        }
    }

    function manualComplete(id) {
        const task = state.tasks.find(t => t.id === id);
        if (task) {
            task.status = 'completed';
            state.tokens += task.reward;
            logAction(`Task completed: ${task.name}`);
            saveData();
        }
    }

    function manualFail(id) {
        const task = state.tasks.find(t => t.id === id);
        if (task) {
            task.status = 'failed';
            state.tokens -= task.penalty;
            logAction(`Task failed: ${task.name}`);
            saveData();
        }
    }

    // --- LIBRARY LOGIC ---
    function addToLibrary() {
        const name = document.getElementById('lib-name').value;
        const mins = parseFloat(document.getElementById('lib-time').value);
        const reward = parseFloat(document.getElementById('lib-reward').value);
        const penalty = parseFloat(document.getElementById('lib-penalty').value);

        if (!name || isNaN(mins) || isNaN(reward) || isNaN(penalty)) return;

        state.library.push({ id: createId(), name, mins, reward, penalty });
        saveData();
        
        // Clear inputs
        document.getElementById('lib-name').value = '';
        document.getElementById('lib-time').value = '';
        document.getElementById('lib-reward').value = '';
        document.getElementById('lib-penalty').value = '';
    }

    function deleteFromLibrary(id) {
        state.library = state.library.filter(t => t.id !== id);
        saveData();
    }

    function startFromLibrary(libId) {
        const libItem = state.library.find(t => t.id === libId);
        if (libItem) {
            addTaskToState(libItem.name, libItem.mins, libItem.reward, libItem.penalty);
            showPage('running');
        }
    }

    function toggleControls() {
        state.showControls = document.getElementById('control-toggle').checked;
        saveData();
    }

    // --- TIMER LOOP ---
    let pendingModalTask = null;

    function tick() {
        const now = Date.now();
        let needsSave = false;

        state.tasks.forEach(task => {
            if (task.status === 'running') {
                const remaining = task.endTime - now;
                
                // Update DOM directly for smoothness if element exists
                const timeDisplay = document.getElementById(`time-${task.id}`);
                const barFill = document.getElementById(`bar-${task.id}`);
                
                if (timeDisplay && barFill) {
                    timeDisplay.innerText = formatTime(Math.max(0, remaining));
                    const percent = Math.max(0, (remaining / task.totalTime) * 100);
                    barFill.style.width = percent + '%';
                }

                if (remaining <= 0) {
                    // Trigger Modal
                    task.remaining = 0;
                    task.status = 'pending_decision'; // Temporary state waiting for user
                    pendingModalTask = task;
                    showModal(task);
                    needsSave = true;
                }
            }
        });

        if (needsSave) saveData();
        requestAnimationFrame(tick);
    }

    // --- MODAL LOGIC ---
    function showModal(task) {
        document.getElementById('modal-task-name').innerText = task.name;
        document.getElementById('modal-overlay').classList.add('active');
    }

    function resolveTask(completed) {
        document.getElementById('modal-overlay').classList.remove('active');
        if (!pendingModalTask) return;

        if (completed) {
            pendingModalTask.status = 'completed';
            state.tokens += pendingModalTask.reward;
            logAction(`Task completed: ${pendingModalTask.name}`);
        } else {
            pendingModalTask.status = 'failed';
            state.tokens -= pendingModalTask.penalty;
            logAction(`Task failed: ${pendingModalTask.name}`);
        }
        
        pendingModalTask = null;
        saveData();
    }

    // --- HELPERS ---
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        const millis = Math.floor((ms % 1000) / 100); // 1 digit for tenths
        
        const pad = n => n.toString().padStart(2, '0');
        if (hours > 0) return `${hours}:${pad(minutes)}:${pad(seconds)}`;
        return `${pad(minutes)}:${pad(seconds)}.${millis}`;
    }

    function isTaskRunning(name) {
        return state.tasks.some(t => t.name === name && t.status === 'running');
    }

    // --- RENDERING ---
    function renderAll() {
        document.getElementById('token-count').innerText = state.tokens;
        document.getElementById('activity-log').innerHTML = state.logs.map(l => `<div>${l}</div>`).join('');
        document.getElementById('control-toggle').checked = state.showControls;

        renderRunning();
        renderPaused();
        renderCompleted();
        renderFailed();
        renderLibrary();
    }

    function renderRunning() {
        const container = document.getElementById('running-list');
        container.innerHTML = state.tasks.filter(t => t.status === 'running').map(task => `
            <div class="card">
                <h3>${task.name}</h3>
                <div class="progress-bar"><div class="progress-fill" id="bar-${task.id}" style="width:100%"></div></div>
                <div class="timer-display" id="time-${task.id}">Calculating...</div>
                <div class="controls">
                    <button onclick="pauseTask('${task.id}')">⏸ Pause</button>
                    <button onclick="manualComplete('${task.id}')" class="accent">✅ Completed</button>
                    <button onclick="manualFail('${task.id}')" class="danger">❌ Not Completed</button>
                </div>
            </div>
        `).join('');
    }

    function renderPaused() {
        const container = document.getElementById('paused-list');
        container.innerHTML = state.tasks.filter(t => t.status === 'paused').map(task => `
            <div class="card">
                <h3>${task.name}</h3>
                <div>Remaining: ${formatTime(task.remaining)}</div>
                <br>
                <div class="controls">
                    <button onclick="resumeTask('${task.id}')">Resume</button>
                </div>
            </div>
        `).join('');
    }

    function renderCompleted() {
        const container = document.getElementById('completed-list');
        container.innerHTML = state.tasks.filter(t => t.status === 'completed').map(task => `
            <div class="card" style="border-left: 5px solid green">
                <h3>${task.name}</h3>
                <div>Total Time: ${Math.round(task.totalTime/60000)} mins</div>
                <div>Reward: +${task.reward}</div>
            </div>
        `).join('');
    }

    function renderFailed() {
        const container = document.getElementById('failed-list');
        container.innerHTML = state.tasks.filter(t => t.status === 'failed').map(task => `
            <div class="card" style="border-left: 5px solid red">
                <h3>${task.name}</h3>
                <div>Total Time: ${Math.round(task.totalTime/60000)} mins</div>
                <div>Penalty: -${task.penalty}</div>
            </div>
        `).join('');
    }

    function renderLibrary() {
        const container = document.getElementById('library-list');
        container.innerHTML = state.library.map(item => {
            const isRunning = isTaskRunning(item.name);
            const showStart = state.showControls || !isRunning;
            
            return `
            <div class="card">
                <h3>${item.name} (${item.mins}m)</h3>
                <div>Reward: ${item.reward} | Penalty: ${item.penalty}</div>
                <div class="controls" style="margin-top:10px">
                    ${showStart ? `<button onclick="startFromLibrary('${item.id}')">Start</button>` : `<span style="opacity:0.5; padding:10px">Running...</span>`}
                    <button onclick="deleteFromLibrary('${item.id}')" class="danger">Delete</button>
                </div>
            </div>
        `}).join('');
    }

    // --- NAVIGATION ---
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
        
        document.getElementById(pageId).classList.add('active');
        document.getElementById('nav-' + pageId).classList.add('active');
    }

    // --- RESETS ---
    function resetTokens() {
        state.tokens = 0;
        logAction('Tokens reset');
        saveData();
    }

    function resetPage(pageType) {
        if (!confirm('Clear this list?')) return;
        if (pageType === 'running' || pageType === 'paused') {
             state.tasks = state.tasks.filter(t => t.status !== pageType);
        } else {
             state.tasks = state.tasks.filter(t => t.status !== pageType);
        }
        logAction(`${pageType} reset`);
        saveData();
    }

    function resetAllTasks() {
        if (!confirm('Reset all progress?')) return;
        state.tasks = [];
        logAction('All tasks reset');
        saveData();
    }

    function masterReset() {
        if (!confirm('DELETE EVERYTHING? Library, Tokens, History?')) return;
        localStorage.removeItem('offlineTimerState');
        location.reload();
    }

    // --- THEMES ---
    const themes = [
        "Default Light", "Dark Mode", "Cream", "Cyan Light", "Solarized Dark", 
        "Solarized Light", "Atom", "Nordic", "Pink", "Mint", 
        "High Contrast", "Cyber", "Coffee", "Deep Purple", "Lavender", 
        "Olive", "Slate", "Burnt Orange", "Ocean", "Gray & Gold"
    ];

    function initThemes() {
        const select = document.getElementById('theme-selector');
        themes.forEach((t, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = t;
            select.appendChild(opt);
        });
    }

    function applyTheme() {
        document.body.className = `theme-${parseInt(state.themeIndex) + 1}`;
        document.getElementById('theme-selector').value = state.themeIndex;
    }

    function changeTheme() {
        state.themeIndex = document.getElementById('theme-selector').value;
        applyTheme();
        logAction(`Theme changed to ${themes[state.themeIndex]}`);
        saveData();
    }

    // --- INIT ---
    initThemes();
    loadData();

</script>
</body>
</html>

